<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Avatar English Coach - Speak Fluent English</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        body.light-theme {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            color: var(--dark);
        }

        /* Glassmorphism */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 0;
            animation: fadeInDown 0.8s;
        }

        .header h1 {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s;
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(20deg);
        }

        /* Avatar Selection Screen */
        .avatar-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
            animation: fadeIn 1s;
        }

        .avatar-card {
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .avatar-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }

        .avatar-card:hover::before {
            opacity: 0.2;
        }

        .avatar-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .avatar-icon {
            font-size: 4em;
            margin-bottom: 15px;
            display: block;
        }

        .avatar-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .avatar-card p {
            opacity: 0.8;
            font-size: 0.95em;
        }

        /* Context Input */
        .context-input {
            max-width: 600px;
            margin: 30px auto;
            padding: 30px;
            text-align: center;
            animation: fadeIn 0.8s;
        }

        .context-input h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .context-input input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 20px;
        }

        .context-input input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        /* Conversation Screen */
        .conversation-screen {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            animation: fadeIn 0.8s;
        }

        .main-area {
            padding: 30px;
        }

        .avatar-display {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .avatar-image {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6em;
            margin: 0 auto 20px;
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .avatar-image.speaking {
            animation: pulse 1s infinite, float 3s ease-in-out infinite;
        }

        .waveform {
            display: flex;
            justify-content: center;
            gap: 5px;
            height: 50px;
            align-items: center;
            margin: 20px 0;
        }

        .wave-bar {
            width: 4px;
            background: white;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .wave-bar:nth-child(1) { animation-delay: 0s; height: 10px; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 20px; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 30px; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 40px; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 30px; }
        .wave-bar:nth-child(6) { animation-delay: 0.5s; height: 20px; }
        .wave-bar:nth-child(7) { animation-delay: 0.6s; height: 10px; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }

        .subtitle-box {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            min-height: 80px;
            font-size: 1.2em;
            text-align: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }

        .mic-btn:hover {
            transform: scale(1.1);
        }

        .mic-btn.listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Sidebar */
        .sidebar {
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .stat-card {
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .transcript {
            padding: 20px;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .transcript h3 {
            margin-bottom: 15px;
        }

        .transcript-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }

        .transcript-item.user {
            background: rgba(99, 102, 241, 0.3);
        }

        .transcript-item.ai {
            background: rgba(139, 92, 246, 0.3);
        }

        /* Report Screen */
        .report-screen {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            animation: fadeIn 0.8s;
        }

        .report-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .report-header h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .score-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--success), #059669);
            opacity: 0.8;
            z-index: -1;
        }

        .score-card.warning::before {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        .score-card.danger::before {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .score-value {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .mistakes-section {
            padding: 25px;
            margin-bottom: 20px;
        }

        .mistake-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
        }

        .mistake-wrong {
            color: var(--danger);
            text-decoration: line-through;
            font-weight: bold;
        }

        .mistake-correct {
            color: var(--success);
            font-weight: bold;
        }

        .recommendations {
            padding: 25px;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--success);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .conversation-screen {
                grid-template-columns: 1fr;
            }

            .avatar-selection {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 2em;
            }

            .score-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()">üåô</div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üé≠ AI Avatar English Coach</h1>
            <p>Practice English with AI avatars - Speak naturally, improve fluently</p>
        </div>

        <!-- Avatar Selection Screen -->
        <div id="avatarSelectionScreen">
            <div class="avatar-selection">
                <div class="avatar-card glass" onclick="selectAvatar('teacher', 'üë©‚Äçüè´')">
                    <span class="avatar-icon">üë©‚Äçüè´</span>
                    <h3>Teacher</h3>
                    <p>Learn grammar, vocabulary, and pronunciation with a patient English teacher</p>
                </div>
                <div class="avatar-card glass" onclick="selectAvatar('interviewer', 'üßë‚Äçüíº')">
                    <span class="avatar-icon">üßë‚Äçüíº</span>
                    <h3>Interviewer</h3>
                    <p>Practice job interviews with realistic questions and professional feedback</p>
                </div>
                <div class="avatar-card glass" onclick="selectAvatar('friend', 'üßë‚Äçü§ù‚Äçüßë')">
                    <span class="avatar-icon">üßë‚Äçü§ù‚Äçüßë</span>
                    <h3>Friend</h3>
                    <p>Have casual conversations to build confidence and fluency naturally</p>
                </div>
                <div class="avatar-card glass" onclick="selectAvatar('client', 'üßë‚Äçüíª')">
                    <span class="avatar-icon">üßë‚Äçüíª</span>
                    <h3>Client</h3>
                    <p>Simulate business meetings and client discussions professionally</p>
                </div>
                <div class="avatar-card glass" onclick="selectAvatar('coach', 'üó£Ô∏è')">
                    <span class="avatar-icon">üó£Ô∏è</span>
                    <h3>Presentation Coach</h3>
                    <p>Master public speaking and presentation skills with expert guidance</p>
                </div>
                <div class="avatar-card glass" onclick="selectAvatar('partner', 'üßë‚Äçüè´')">
                    <span class="avatar-icon">üßë‚Äçüè´</span>
                    <h3>Meeting Partner</h3>
                    <p>Practice corporate meetings and professional communication scenarios</p>
                </div>
            </div>
        </div>

        <!-- Context Input Screen -->
        <div id="contextInputScreen" class="hidden">
            <div class="context-input glass">
                <h2 id="contextQuestion">Loading...</h2>
                <input type="text" id="contextInput" placeholder="Type your answer here...">
                <button class="btn" onclick="startConversation()">Start Practice Session</button>
            </div>
        </div>

        <!-- Conversation Screen -->
        <div id="conversationScreen" class="hidden">
            <div class="conversation-screen">
                <div class="main-area glass">
                    <div class="avatar-display">
                        <div class="avatar-image" id="avatarImage">üë©‚Äçüè´</div>
                        <h2 id="avatarName">Teacher</h2>
                        <div class="waveform hidden" id="waveform">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                    </div>

                    <div class="subtitle-box" id="subtitleBox">
                        Click the microphone to start speaking...
                    </div>

                    <div class="controls">
                        <button class="control-btn" onclick="endSession()" title="End Session">‚èπÔ∏è</button>
                        <button class="mic-btn" id="micBtn" onclick="toggleMic()">üé§</button>
                        <button class="control-btn" onclick="getReport()" title="Get Report">üìä</button>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="stat-card glass">
                        <h3 id="messageCount">0</h3>
                        <p>Messages</p>
                    </div>
                    <div class="stat-card glass">
                        <h3 id="mistakeCount">0</h3>
                        <p>Corrections</p>
                    </div>
                    <div class="stat-card glass">
                        <h3 id="durationDisplay">00:00</h3>
                        <p>Duration</p>
                    </div>

                    <div class="transcript glass">
                        <h3>Conversation</h3>
                        <div id="transcriptList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Screen -->
        <div id="reportScreen" class="hidden">
            <div class="report-screen glass">
                <div class="report-header">
                    <h2>üìä Performance Report</h2>
                    <p>Session with <span id="reportAvatar"></span></p>
                </div>

                <div class="score-grid">
                    <div class="score-card glass" id="grammarCard">
                        <div class="score-value" id="grammarScore">0%</div>
                        <p>Grammar Accuracy</p>
                    </div>
                    <div class="score-card glass" id="vocabularyCard">
                        <div class="score-value" id="vocabularyScore">0%</div>
                        <p>Vocabulary Score</p>
                    </div>
                    <div class="score-card glass" id="fluencyCard">
                        <div class="score-value" id="fluencyScore">0%</div>
                        <p>Fluency Score</p>
                    </div>
                    <div class="score-card glass" id="confidenceCard">
                        <div class="score-value" id="confidenceScore">0%</div>
                        <p>Confidence Level</p>
                    </div>
                </div>

                <div class="mistakes-section glass">
                    <h3>‚ùå Mistakes & Corrections</h3>
                    <div id="mistakesList"></div>
                </div>

                <div class="recommendations glass">
                    <h3>üí° Recommendations</h3>
                    <ul id="recommendationsList"></ul>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="resetApp()">Start New Session</button>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="hidden">
            <div class="loading">
                <div class="spinner"></div>
                <p>AI is thinking...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CHATGPT_API_KEY = '368fb1f1eemshb2a2e312bdee2f4p1dd8f5jsn0800d85fd685';
        const CHATGPT_API_URL = 'https://chatgpt-42.p.rapidapi.com/gpt4';

        // App State
        let currentAvatar = null;
        let avatarIcon = null;
        let context = '';
        let conversationHistory = [];
        let mistakes = [];
        let sessionStartTime = null;
        let durationInterval = null;
        let isListening = false;
        let isSpeaking = false;
        let recognition = null;
        let synth = window.speechSynthesis;
        let selectedVoice = null;

        // Avatar Configurations
        const avatarConfigs = {
            teacher: {
                name: 'English Teacher',
                question: 'What aspect of English would you like to focus on? (Grammar, Vocabulary, Pronunciation, or General Practice)',
                systemPrompt: 'You are a patient and encouraging English teacher. Help users improve their grammar, vocabulary, and pronunciation. After each user response, gently correct mistakes and explain why. Keep responses concise (2-3 sentences). Always be supportive and motivating.'
            },
            interviewer: {
                name: 'Job Interviewer',
                question: 'What job role are you preparing for? (e.g., Software Engineer, Marketing Manager, Sales Executive)',
                systemPrompt: 'You are a professional job interviewer. Ask realistic interview questions one by one based on the job role. After each answer, provide brief feedback on communication style and suggest improvements. Be professional but friendly. Keep questions focused and responses concise.'
            },
            friend: {
                name: 'Friendly Companion',
                question: 'What topics interest you? (e.g., Movies, Sports, Travel, Technology, Food)',
                systemPrompt: 'You are a friendly English-speaking companion. Have casual, natural conversations about everyday topics. Gently correct major mistakes but keep the conversation flowing naturally. Be enthusiastic and encouraging. Keep responses conversational and brief (2-3 sentences).'
            },
            client: {
                name: 'Business Client',
                question: 'What type of business scenario would you like to practice? (e.g., Project Discussion, Negotiation, Presentation)',
                systemPrompt: 'You are a business client in a professional meeting. Discuss projects, ask questions about deliverables, and engage in business conversations. Provide feedback on professional communication tone. Be direct but polite. Keep responses business-focused and concise.'
            },
            coach: {
                name: 'Presentation Coach',
                question: 'What type of presentation are you preparing? (e.g., Sales Pitch, Technical Talk, Conference Speech)',
                systemPrompt: 'You are a presentation and public speaking coach. Help users practice their presentation skills. Give feedback on clarity, structure, and delivery. Suggest better phrasing and more impactful words. Be constructive and specific. Keep feedback actionable and brief.'
            },
            partner: {
                name: 'Meeting Partner',
                question: 'What type of meeting would you like to simulate? (e.g., Team Standup, Strategy Discussion, Performance Review)',
                systemPrompt: 'You are a corporate colleague in a professional meeting. Discuss work topics, share ideas, and provide feedback on communication effectiveness. Help improve professional vocabulary and tone. Be collaborative and supportive. Keep responses meeting-appropriate and concise.'
            }
        };

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                handleUserSpeech(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error !== 'no-speech') {
                    showSubtitle('Sorry, I couldn\'t hear you clearly. Please try again.');
                }
            };

            recognition.onend = () => {
                if (isListening && !isSpeaking) {
                    recognition.start(); // Auto-restart for continuous listening
                }
            };
        }

        // Load voices
        function loadVoices() {
            const voices = synth.getVoices();
            const englishVoices = voices.filter(v => v.lang.startsWith('en'));
            selectedVoice = englishVoices.find(v => v.name.includes('Google') || v.name.includes('Microsoft')) || englishVoices[0];
        }

        loadVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }

        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const toggle = document.querySelector('.theme-toggle');
            toggle.textContent = document.body.classList.contains('light-theme') ? '‚òÄÔ∏è' : 'üåô';
        }

        // Select Avatar
        function selectAvatar(type, icon) {
            currentAvatar = type;
            avatarIcon = icon;
            const config = avatarConfigs[type];
            
            document.getElementById('avatarSelectionScreen').classList.add('hidden');
            document.getElementById('contextInputScreen').classList.remove('hidden');
            document.getElementById('contextQuestion').textContent = config.question;
        }

        // Start Conversation
        async function startConversation() {
            context = document.getElementById('contextInput').value.trim();
            if (!context) {
                alert('Please provide context for the conversation');
                return;
            }

            document.getElementById('contextInputScreen').classList.add('hidden');
            document.getElementById('conversationScreen').classList.remove('hidden');

            const config = avatarConfigs[currentAvatar];
            document.getElementById('avatarImage').textContent = avatarIcon;
            document.getElementById('avatarName').textContent = config.name;

            sessionStartTime = Date.now();
            startDurationTimer();

            // Initial AI greeting
            const greeting = await getAIResponse(`User context: ${context}. Start the conversation with a brief, friendly greeting and first question.`);
            addToTranscript('AI', greeting);
            showSubtitle(greeting);
            await speak(greeting);

            // Start listening
            startListening();
        }

        // Toggle Microphone
        function toggleMic() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        // Start Listening
        function startListening() {
            if (!recognition) {
                alert('Speech recognition not supported in this browser');
                return;
            }

            isListening = true;
            recognition.start();
            document.getElementById('micBtn').classList.add('listening');
            showSubtitle('Listening... Speak now');
        }

        // Stop Listening
        function stopListening() {
            isListening = false;
            if (recognition) {
                recognition.stop();
            }
            document.getElementById('micBtn').classList.remove('listening');
        }

        // Handle User Speech
        async function handleUserSpeech(text) {
            if (!text.trim() || isSpeaking) return;

            stopListening();
            addToTranscript('You', text);
            showSubtitle(`You: ${text}`);

            // Analyze mistakes
            const mistakeAnalysis = analyzeMistakes(text);
            if (mistakeAnalysis.length > 0) {
                mistakes.push(...mistakeAnalysis);
                updateMistakeCount();
            }

            // Get AI response
            showLoading(true);
            const response = await getAIResponse(text);
            showLoading(false);

            addToTranscript('AI', response);
            showSubtitle(response);
            await speak(response);

            // Resume listening
            startListening();
        }

        // Get AI Response from ChatGPT
        async function getAIResponse(userMessage) {
            try {
                const config = avatarConfigs[currentAvatar];
                
                // Build conversation context (keep last 10 messages)
                const recentHistory = conversationHistory.slice(-10);
                const messages = [
                    { role: 'system', content: config.systemPrompt + ` User context: ${context}` },
                    ...recentHistory,
                    { role: 'user', content: userMessage }
                ];

                const response = await fetch(CHATGPT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-RapidAPI-Key': CHATGPT_API_KEY,
                        'X-RapidAPI-Host': 'chatgpt-42.p.rapidapi.com'
                    },
                    body: JSON.stringify({
                        messages: messages,
                        web_access: false
                    })
                });

                const data = await response.json();
                const aiResponse = data.result || 'I apologize, I didn\'t quite understand that. Could you rephrase?';
                
                conversationHistory.push({ role: 'user', content: userMessage });
                conversationHistory.push({ role: 'assistant', content: aiResponse });

                return aiResponse;
            } catch (error) {
                console.error('ChatGPT API Error:', error);
                return 'I\'m having trouble connecting right now. Let\'s continue - what would you like to talk about?';
            }
        }

        // Speak (Text-to-Speech)
        function speak(text) {
            return new Promise((resolve) => {
                if (isSpeaking) {
                    synth.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = selectedVoice;
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;

                isSpeaking = true;
                document.getElementById('avatarImage').classList.add('speaking');
                document.getElementById('waveform').classList.remove('hidden');

                utterance.onend = () => {
                    isSpeaking = false;
                    document.getElementById('avatarImage').classList.remove('speaking');
                    document.getElementById('waveform').classList.add('hidden');
                    resolve();
                };

                utterance.onerror = () => {
                    isSpeaking = false;
                    document.getElementById('avatarImage').classList.remove('speaking');
                    document.getElementById('waveform').classList.add('hidden');
                    resolve();
                };

                synth.speak(utterance);
            });
        }

        // Analyze Mistakes
        function analyzeMistakes(text) {
            const foundMistakes = [];
            const rules = [
                { wrong: /\bi am working from\b/gi, correct: 'I have been working for', type: 'Tense Error' },
                { wrong: /\bhe don't\b/gi, correct: 'he doesn\'t', type: 'Subject-Verb Agreement' },
                { wrong: /\bshe don't\b/gi, correct: 'she doesn\'t', type: 'Subject-Verb Agreement' },
                { wrong: /\bmore better\b/gi, correct: 'better', type: 'Double Comparative' },
                { wrong: /\bmuch people\b/gi, correct: 'many people', type: 'Countable/Uncountable' },
                { wrong: /\bdidn't went\b/gi, correct: 'didn\'t go', type: 'Verb Form' }
            ];

            rules.forEach(rule => {
                if (rule.wrong.test(text)) {
                    const match = text.match(rule.wrong)[0];
                    foundMistakes.push({
                        wrong: match,
                        correct: rule.correct,
                        type: rule.type,
                        sentence: text
                    });
                }
            });

            return foundMistakes;
        }

        // UI Updates
        function showSubtitle(text) {
            document.getElementById('subtitleBox').textContent = text;
        }

        function addToTranscript(speaker, text) {
            const transcriptList = document.getElementById('transcriptList');
            const item = document.createElement('div');
            item.className = `transcript-item ${speaker === 'You' ? 'user' : 'ai'}`;
            item.innerHTML = `<strong>${speaker}:</strong> ${text}`;
            transcriptList.appendChild(item);
            transcriptList.scrollTop = transcriptList.scrollHeight;

            updateMessageCount();
        }

        function updateMessageCount() {
            const count = conversationHistory.length / 2;
            document.getElementById('messageCount').textContent = Math.floor(count);
        }

        function updateMistakeCount() {
            document.getElementById('mistakeCount').textContent = mistakes.length;
        }

        function startDurationTimer() {
            durationInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('durationDisplay').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function showLoading(show) {
            document.getElementById('loadingScreen').classList.toggle('hidden', !show);
        }

        // End Session
        function endSession() {
            if (confirm('Are you sure you want to end this session?')) {
                stopListening();
                synth.cancel();
                clearInterval(durationInterval);
                getReport();
            }
        }

        // Generate Report
        async function getReport() {
            stopListening();
            synth.cancel();
            clearInterval(durationInterval);

            document.getElementById('conversationScreen').classList.add('hidden');
            document.getElementById('reportScreen').classList.remove('hidden');

            const config = avatarConfigs[currentAvatar];
            document.getElementById('reportAvatar').textContent = config.name;

            // Calculate scores
            const totalMessages = conversationHistory.length / 2;
            const grammarScore = Math.max(0, 100 - (mistakes.length / totalMessages * 20));
            const vocabularyScore = Math.min(100, totalMessages * 5);
            const fluencyScore = Math.min(100, totalMessages * 8);
            const confidenceScore = Math.min(100, totalMessages * 6);

            // Display scores with color coding
            displayScore('grammar', grammarScore);
            displayScore('vocabulary', vocabularyScore);
            displayScore('fluency', fluencyScore);
            displayScore('confidence', confidenceScore);

            // Display mistakes
            const mistakesList = document.getElementById('mistakesList');
            if (mistakes.length > 0) {
                mistakesList.innerHTML = mistakes.map(m => `
                    <div class="mistake-item">
                        <strong>${m.type}</strong><br>
                        ‚ùå <span class="mistake-wrong">${m.wrong}</span><br>
                        ‚úÖ <span class="mistake-correct">${m.correct}</span>
                    </div>
                `).join('');
            } else {
                mistakesList.innerHTML = '<p style="text-align: center; padding: 20px;">üéâ Excellent! No major mistakes detected!</p>';
            }

            // Generate recommendations
            const recommendations = generateRecommendations(grammarScore, vocabularyScore, fluencyScore);
            document.getElementById('recommendationsList').innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
        }

        function displayScore(type, score) {
            const scoreElement = document.getElementById(`${type}Score`);
            const cardElement = document.getElementById(`${type}Card`);
            
            scoreElement.textContent = Math.round(score) + '%';
            
            cardElement.classList.remove('warning', 'danger');
            if (score < 60) {
                cardElement.classList.add('danger');
            } else if (score < 80) {
                cardElement.classList.add('warning');
            }
        }

        function generateRecommendations(grammar, vocabulary, fluency) {
            const recommendations = [];
            
            if (grammar < 70) {
                recommendations.push('üìö Focus on basic grammar rules - practice tenses and sentence structure');
                recommendations.push('‚úçÔ∏è Try writing exercises to reinforce grammar concepts');
            } else if (grammar < 90) {
                recommendations.push('üìñ Good grammar foundation! Work on complex sentence structures');
            } else {
                recommendations.push('üåü Excellent grammar! Keep practicing advanced structures');
            }

            if (vocabulary < 70) {
                recommendations.push('üìù Expand your vocabulary - learn 5 new words daily');
                recommendations.push('üìö Read English articles and books regularly');
            } else {
                recommendations.push('üí° Great vocabulary! Try using more idiomatic expressions');
            }

            if (fluency < 70) {
                recommendations.push('üó£Ô∏è Practice speaking daily - even 10 minutes helps');
                recommendations.push('üéß Listen to English podcasts and repeat phrases');
            } else {
                recommendations.push('üöÄ Excellent fluency! Try more complex conversations');
            }

            recommendations.push('üí™ Keep practicing regularly - consistency is key!');
            recommendations.push(`üéØ Try practicing with different avatars for varied scenarios`);

            return recommendations;
        }

        // Reset App
        function resetApp() {
            currentAvatar = null;
            avatarIcon = null;
            context = '';
            conversationHistory = [];
            mistakes = [];
            sessionStartTime = null;
            
            document.getElementById('reportScreen').classList.add('hidden');
            document.getElementById('avatarSelectionScreen').classList.remove('hidden');
            document.getElementById('transcriptList').innerHTML = '';
            document.getElementById('messageCount').textContent = '0';
            document.getElementById('mistakeCount').textContent = '0';
            document.getElementById('durationDisplay').textContent = '00:00';
        }
    </script>
</body>
</html>
